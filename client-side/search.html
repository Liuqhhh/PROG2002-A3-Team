<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charity Events - Search</title>
    <link rel="stylesheet" href="./css/style.css">
</head>
<body>
    <nav>
        <div class="nav-container">
            <h1>ü§ù Charity Events</h1>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="search.html" class="active">Search</a></li>
                <li><a href="registration.html">Register</a></li>
            </ul>
        </div>
    </nav>

    <main>
        <section class="search-form">
            <h2>Find Charity Events</h2>
            <p>Search for events that match your interests and availability</p>
            
            <form id="search-form">
                <div class="form-group">
                    <label for="category">Event Category:</label>
                    <select id="category" name="category">
                        <option value="">All Categories</option>
                        <!-- Categories will be loaded dynamically -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="location">Location:</label>
                    <input type="text" id="location" name="location" placeholder="Enter city, venue, or area">
                </div>
                
                <div class="form-group">
                    <label for="date">Date:</label>
                    <input type="date" id="date" name="date">
                </div>
                
                <div class="form-buttons">
                    <button type="submit" class="btn">üîç Search Events</button>
                    <button type="button" id="clear-filters" class="btn btn-secondary">üóëÔ∏è Clear Filters</button>
                </div>
            </form>
        </section>

        <section class="search-results">
            <h3>Search Results</h3>
            <div id="search-results">
                <div class="search-placeholder">
                    <h4>Ready to Search</h4>
                    <p>Use the search form above to find charity events that match your interests.</p>
                    <p>You can filter by category, location, or specific date.</p>
                </div>
            </div>
        </section>
    </main>

    <script>

    const API_BASE_URL = 'https://f3ce1f1f7e196724bc049b8111b70e55.serveo.net/api';

    async function loadCategories() {
        try {
            const response = await fetch(`${API_BASE_URL}/categories`);
            const result = await response.json();
            
            const categorySelect = document.getElementById('category');
            if (result && Array.isArray(result) && result.length > 0) {
  
                categorySelect.innerHTML = '<option value="">All Categories</option>' + 
                    result.map(cat => `<option value="${cat.name || cat.id}">${cat.name}</option>`).join('');
            } else if (result && result.success && result.data) {

                categorySelect.innerHTML = '<option value="">All Categories</option>' + 
                    result.data.map(cat => `<option value="${cat.name || cat.id}">${cat.name}</option>`).join('');
            } else {
                categorySelect.innerHTML = '<option value="">No categories available</option>';
            }
        } catch (error) {
            console.error('Error loading categories:', error);
            document.getElementById('category').innerHTML = '<option value="">Error loading categories</option>';
        }
    }

    async function searchEvents(filters = {}) {
        try {
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '<div class="loading">Searching events...</div>';


            const response = await fetch(`${API_BASE_URL}/events`);
            let events = await response.json();
            
            console.log('All events:', events);


            if (filters.category) {
                events = events.filter(event => 
                    event.category_name === filters.category || 
                    event.category === filters.category
                );
            }
            
            if (filters.location) {
                events = events.filter(event => 
                    event.location.toLowerCase().includes(filters.location.toLowerCase())
                );
            }
            
            if (filters.date) {
                const filterDate = new Date(filters.date).toDateString();
                events = events.filter(event => 
                    new Date(event.date).toDateString() === filterDate
                );
            }

            console.log('Filtered events:', events);
            
            if (events.length > 0) {
                resultsContainer.innerHTML = `
                    <div class="results-header">
                        <h4>Found ${events.length} Event(s)</h4>
                    </div>
                    <div class="events-grid">
                        ${events.map(event => `
                            <div class="event-card">
                                <div class="event-header">
                                    <h4><a href="event-details.html?id=${event.id}">${event.name}</a></h4>
                                    <span class="event-category">${event.category_name || event.category || 'General'}</span>
                                </div>
                                <p><strong>üìÖ Date:</strong> ${new Date(event.date).toLocaleDateString()}</p>
                                <p><strong>üìç Location:</strong> ${event.location}</p>
                                <p><strong>üéØ Category:</strong> ${event.category_name || event.category || 'General'}</p>
                                <div class="event-purpose">
                                    <p><strong>Purpose:</strong> ${event.purpose || 'Supporting charitable causes'}</p>
                                </div>
                                <p>${event.description || 'No description available'}</p>
                                <p class="ticket-price"><strong>üí∞ Ticket Price:</strong> $${event.ticket_price || 0}</p>
                                <a href="event-details.html?id=${event.id}" class="view-details-btn">View Details & Register</a>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <h4>No Events Found</h4>
                        <p>No events match your search criteria. Try adjusting your filters.</p>
                        <button onclick="document.getElementById('clear-filters').click()" class="btn">Clear Filters</button>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error searching events:', error);
            document.getElementById('search-results').innerHTML = `
                <div class="error-message">
                    <p>Error searching events. Please try again later.</p>
                    <p>Error details: ${error.message}</p>
                    <button onclick="searchEvents()" class="btn">üîÑ Retry Search</button>
                </div>
            `;
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadCategories();
        
        document.getElementById('search-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            searchEvents({
                category: formData.get('category'),
                location: formData.get('location'),
                date: formData.get('date')
            });
        });
        
        document.getElementById('clear-filters').addEventListener('click', function() {
            document.getElementById('search-form').reset();
            document.getElementById('search-results').innerHTML = `
                <div class="search-placeholder">
                    <h4>Ready to Search</h4>
                    <p>Use the search form above to find charity events that match your interests.</p>
                    <p>You can filter by category, location, or specific date.</p>
                </div>
            `;
        });


        searchEvents();
    });
</script>
</body>
</html>